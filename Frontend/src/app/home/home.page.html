<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Feueralarm</ion-title>
    <ion-buttons slot="end">
      <!-- *** NEU: Online/Offline Status *** -->
      <ion-chip
        [color]="isOnline ? 'success' : 'danger'"
        style="margin-right: 8px"
      >
        <ion-icon [name]="isOnline ? 'wifi' : 'cloud-offline'"></ion-icon>
        <ion-label>{{ isOnline ? 'Online' : 'Offline' }}</ion-label>
      </ion-chip>

      <!-- *** GEÄNDERT: Dashboard Button (nur für Admin/Verwaltung) *** -->
      <ion-button *ngIf="canAccessDashboard" (click)="openDashboard()">
        <ion-icon name="stats-chart-outline" slot="icon-only"></ion-icon>
      </ion-button>

      <!-- *** NEU: Audit-Logs Button (nur für Admin/Verwaltung) *** -->
      <ion-button *ngIf="canAccessDashboard" (click)="openAuditLogs()">
        <ion-icon name="document-text-outline" slot="icon-only"></ion-icon>
      </ion-button>

      <!-- Admin User Management Button -->
      <ion-button *ngIf="isAdmin" (click)="openUserManagement()">
        <ion-icon name="people-outline" slot="icon-only"></ion-icon>
      </ion-button>
      <!-- Archive Button -->
      <ion-button (click)="openArchive()">
        <ion-icon name="archive-outline" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button (click)="openSettings()">
        <ion-icon name="settings-outline" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button (click)="openInformation()">
        <ion-icon name="information-circle-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- *** NEU: Sync-Status Banner (nur wenn offline oder pending) *** -->
  <ion-card
    *ngIf="!isOnline || pendingActions > 0"
    color="warning"
    style="margin: 8px"
  >
    <ion-card-content>
      <div style="display: flex; align-items: center; gap: 12px">
        <ion-icon
          [name]="isSyncing ? 'sync-outline' : 'cloud-offline'"
          size="large"
        ></ion-icon>
        <div style="flex: 1">
          <strong *ngIf="!isOnline">Offline-Modus</strong>
          <strong *ngIf="isOnline && pendingActions > 0"
            >{{ pendingActions }} ausstehende Änderungen</strong
          >
          <p style="margin: 4px 0 0 0; font-size: 0.9em">
            <span *ngIf="!isOnline">Änderungen werden lokal gespeichert</span>
            <span *ngIf="isOnline && pendingActions > 0"
              >Klicke auf Sync um zu synchronisieren</span
            >
          </p>
        </div>
        <ion-button
          *ngIf="isOnline && pendingActions > 0"
          (click)="forceSyncNow()"
          [disabled]="isSyncing"
          size="small"
        >
          <ion-icon slot="start" name="sync-outline"></ion-icon>
          {{ isSyncing ? 'Syncing...' : 'Sync' }}
        </ion-button>
      </div>
      <ion-progress-bar
        *ngIf="isSyncing"
        type="indeterminate"
        style="margin-top: 8px"
      ></ion-progress-bar>
    </ion-card-content>
  </ion-card>

  <!-- Admin: Feueralarm Button -->
  <div class="alarm-section" *ngIf="isAdmin">
    <div class="alarm-controls">
      <!-- Stunden Auswahl -->
      <div class="hour-picker">
        <ion-select
          [(ngModel)]="selectedHour"
          interface="popover"
          placeholder="Stunde wählen"
        >
          <ion-select-option
            *ngFor="let hour of schoolHours"
            [value]="hour.time"
          >
            {{ hour.label }}
          </ion-select-option>
        </ion-select>
      </div>

      <!-- Alarm Button -->
      <button class="alarm-button" (click)="triggerAlarm()">
        <ion-icon name="notifications"></ion-icon>
        Feueralarm auslösen
      </button>
    </div>
  </div>

  <!-- Filter & Search -->
  <div class="filter-section">
    <!-- Status Filter -->
    <div class="status-filter">
      <ion-segment [(ngModel)]="selectedStatus" (ionChange)="onStatusChange()">
        <ion-segment-button value="4">
          <ion-label>Alle ({{ stats.total }})</ion-label>
        </ion-segment-button>
        <ion-segment-button value="1">
          <ion-label>Offen ({{ stats.open }})</ion-label>
        </ion-segment-button>
        <ion-segment-button value="2">
          <ion-label>✓ ({{ stats.present }})</ion-label>
        </ion-segment-button>
        <ion-segment-button value="3">
          <ion-label>✗ ({{ stats.incomplete }})</ion-label>
        </ion-segment-button>
      </ion-segment>
    </div>

    <!-- Search Bar -->
    <div class="search-bar">
      <ion-searchbar
        [(ngModel)]="searchTerm"
        (ionInput)="onSearch()"
        (ionClear)="onSearch()"
        placeholder="Suchen..."
        animated
      ></ion-searchbar>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-state" *ngIf="isLoading">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Lade Daten...</p>
  </div>

  <!-- Teacher List -->
  <div class="teacher-list" *ngIf="!isLoading">
    <!-- Empty State -->
    <div class="empty-state" *ngIf="filteredTeachers.length === 0">
      <ion-icon name="search-outline"></ion-icon>
      <h3>Keine Einträge gefunden</h3>
      <p *ngIf="searchTerm">Versuche einen anderen Suchbegriff</p>
    </div>

    <!-- Teacher Cards -->
    <div
      class="teacher-card"
      *ngFor="let teacher of filteredTeachers"
      [class.fade-in]="true"
    >
      <!-- Header -->
      <div class="card-header">
        <div class="teacher-info">
          <!-- Teacher Names or Class -->
          <h3 *ngIf="sortBy === 'teacher'">
            <span *ngFor="let name of teacher.names; let last = last">
              {{ name }}<span *ngIf="!last">, </span>
            </span>
          </h3>
          <h3 *ngIf="sortBy === 'class'">{{ teacher.class }}</h3>

          <!-- Sub Info -->
          <p class="sub-info" *ngIf="sortBy === 'teacher'">
            Klasse: {{ teacher.class }} ({{ teacher.classNumber }})
          </p>
          <p class="sub-info" *ngIf="sortBy === 'class'">
            Kürzel: {{ teacher.classNumber }} | Lehrer:
            <span *ngFor="let name of teacher.names; let last = last">
              {{ name }}<span *ngIf="!last">, </span>
            </span>
          </p>

          <!-- Room & Status -->
          <div class="meta-info">
            <span class="room-badge">
              <ion-icon name="location-outline"></ion-icon>
              <span *ngFor="let room of teacher.room; let last = last">
                {{ room }}<span *ngIf="!last">, </span>
              </span>
            </span>
            <span class="status-badge" [ngClass]="'status-' + teacher.state">
              {{ getStatusLabel(teacher.state) }}
            </span>
          </div>
        </div>

        <!-- Action Icons -->
        <div class="header-actions">
          <!-- Comment Button -->
          <button class="icon-button" (click)="addComment(teacher)">
            <ion-icon name="chatbox-outline"></ion-icon>
          </button>

          <!-- ✅ NEU: Attachment Button -->
          <button class="icon-button" (click)="openAttachments(teacher)">
            <ion-icon name="camera"></ion-icon>
          </button>
        </div>
      </div>

      <!-- Comment Display -->
      <div class="comment-section" *ngIf="teacher.comment">
        <div class="comment-content">
          <ion-icon name="chatbox"></ion-icon>
          <p>{{ teacher.comment }}</p>
        </div>
        <button class="icon-button delete" (click)="deleteComment(teacher)">
          <ion-icon name="trash-outline"></ion-icon>
        </button>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button
          class="action-btn incomplete"
          (click)="setIncomplete(teacher)"
          [class.active]="teacher.state === 3"
        >
          <ion-icon name="close-circle"></ion-icon>
          Unvollständig
        </button>
        <button
          class="action-btn present"
          (click)="setPresent(teacher)"
          [class.active]="teacher.state === 2"
        >
          <ion-icon name="checkmark-circle"></ion-icon>
          Anwesend
        </button>
      </div>
    </div>
  </div>
</ion-content>
<!-- Alarm Footer -->
<app-alarm-footer
  [hasActiveAlarm]="hasActiveAlarm"
  [isProcessing]="isProcessingAlarm"
  (endAlarm)="endAndArchiveAlarm()"
  (exportPDF)="exportCurrentAlarmPDF()"
  (exportCSV)="exportCurrentAlarmCSV()"
></app-alarm-footer>
